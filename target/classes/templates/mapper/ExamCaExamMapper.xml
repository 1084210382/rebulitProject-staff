<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.trainExam.dao.ExamCaExamMapper">
  <resultMap id="BaseResultMap" type="com.example.demo.trainExam.model.ExamCaExam">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jun 05 16:55:13 CST 2021.
    -->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="ca_id" jdbcType="INTEGER" property="caId" />
    <result column="ca_code" jdbcType="VARCHAR" property="caCode" />
    <result column="exam_id" jdbcType="INTEGER" property="examId" />
    <result column="exam_score" jdbcType="REAL" property="examScore" />
    <result column="exam_result" jdbcType="INTEGER" property="examResult" />
    <result column="exam_date" jdbcType="TIMESTAMP" property="examDate" />
    <result column="operator" jdbcType="VARCHAR" property="operator" />
    <result column="operate_time" jdbcType="TIMESTAMP" property="operateTime" />
    <result column="operate_ip" jdbcType="VARCHAR" property="operateIp" />
  </resultMap>

  <resultMap id="ExamQualifyMap" extends = "BaseResultMap" type="com.example.demo.trainExam.controller.param.ExamCaQualifyParam">
    <result column="username" jdbcType="VARCHAR" property="userName" />
  </resultMap>

  <resultMap id="ExamEnquiryMap" type="com.example.demo.trainExam.controller.param.ExamEnquiryParam">
    <!--    <id column="id" jdbcType="INTEGER" property="id" />-->
    <id column="user_id" jdbcType="INTEGER" property="id" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="id_number" jdbcType="VARCHAR" property="idNumber" />
    <result column="telephone" jdbcType="VARCHAR" property="telephone" />
    <result column="sexy" jdbcType="INTEGER" property="sexy" />
    <result column="industry" jdbcType="INTEGER" property="industry" />
    <result column="work_type" jdbcType="INTEGER" property="workType" />
    <result column="company_name" jdbcType="VARCHAR" property="companyName" />
    <result column="photo" jdbcType="VARCHAR" property="photo" />
    <result column="exam_score" jdbcType="REAL" property="examScore" />
    <result column="exam_result" jdbcType="INTEGER" property="examResult" />
    <result column="exam_name" jdbcType="VARCHAR" property="examName" />
    <result column="exam_id" jdbcType="INTEGER" property="examId" />
    <result column="subject_id" jdbcType="INTEGER" property="subjectId" />
    <result column="exam_date" jdbcType="TIMESTAMP" property="examDate" />
    <result column="electronic_number" jdbcType="VARCHAR" property="electronicNumber" />
    <result column="credit_number" jdbcType="VARCHAR" property="creditNumber" />
    <result column="business_address" jdbcType="VARCHAR" property="businessAddress" />
    <result column="total_score" jdbcType="REAL" property="totalScore" />
    <result column="qualified_score" jdbcType="REAL" property="qualifiedScore" />
    <result column="exam_time" jdbcType="INTEGER" property="examTime" />
  </resultMap>

  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jun 05 16:55:13 CST 2021.
    -->
    id, ca_id, ca_code, exam_id, exam_score, exam_result, exam_date, operator, operate_time,
    operate_ip
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jun 05 16:55:13 CST 2021.
    -->
    select
    <include refid="Base_Column_List" />
    from exam_ca_exam
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jun 05 16:55:13 CST 2021.
    -->
    delete from exam_ca_exam
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.example.demo.trainExam.model.ExamCaExam" keyColumn="id" keyProperty="id" useGeneratedKeys="true">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jun 05 16:55:13 CST 2021.
    -->
    insert into exam_ca_exam (id, ca_id, ca_code,
      exam_id, exam_score, exam_result,
      exam_date, operator, operate_time,
      operate_ip)
    values (#{id,jdbcType=INTEGER}, #{caId,jdbcType=INTEGER}, #{caCode,jdbcType=VARCHAR},
      #{examId,jdbcType=INTEGER}, #{examScore,jdbcType=REAL}, #{examResult,jdbcType=INTEGER},
      #{examDate,jdbcType=TIMESTAMP}, #{operator,jdbcType=VARCHAR}, #{operateTime,jdbcType=TIMESTAMP},
      #{operateIp,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.example.demo.trainExam.model.ExamCaExam" keyColumn="id" keyProperty="id" useGeneratedKeys="true">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jun 05 16:55:13 CST 2021.
    -->
    insert into exam_ca_exam
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="caId != null">
        ca_id,
      </if>
      <if test="caCode != null">
        ca_code,
      </if>
      <if test="examId != null">
        exam_id,
      </if>
      <if test="examScore != null">
        exam_score,
      </if>
      <if test="examResult != null">
        exam_result,
      </if>
      <if test="examDate != null">
        exam_date,
      </if>
      <if test="operator != null">
        operator,
      </if>
      <if test="operateTime != null">
        operate_time,
      </if>
      <if test="operateIp != null">
        operate_ip,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=INTEGER},
      </if>
      <if test="caId != null">
        #{caId,jdbcType=INTEGER},
      </if>
      <if test="caCode != null">
        #{caCode,jdbcType=VARCHAR},
      </if>
      <if test="examId != null">
        #{examId,jdbcType=INTEGER},
      </if>
      <if test="examScore != null">
        #{examScore,jdbcType=REAL},
      </if>
      <if test="examResult != null">
        #{examResult,jdbcType=INTEGER},
      </if>
      <if test="examDate != null">
        #{examDate,jdbcType=TIMESTAMP},
      </if>
      <if test="operator != null">
        #{operator,jdbcType=VARCHAR},
      </if>
      <if test="operateTime != null">
        #{operateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="operateIp != null">
        #{operateIp,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.example.demo.trainExam.model.ExamCaExam">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jun 05 16:55:13 CST 2021.
    -->
    update exam_ca_exam
    <set>
      <if test="caId != null">
        ca_id = #{caId,jdbcType=INTEGER},
      </if>
      <if test="caCode != null">
        ca_code = #{caCode,jdbcType=VARCHAR},
      </if>
      <if test="examId != null">
        exam_id = #{examId,jdbcType=INTEGER},
      </if>
      <if test="examScore != null">
        exam_score = #{examScore,jdbcType=REAL},
      </if>
      <if test="examResult != null">
        exam_result = #{examResult,jdbcType=INTEGER},
      </if>
      <if test="examDate != null">
        exam_date = #{examDate,jdbcType=TIMESTAMP},
      </if>
      <if test="operator != null">
        operator = #{operator,jdbcType=VARCHAR},
      </if>
      <if test="operateTime != null">
        operate_time = #{operateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="operateIp != null">
        operate_ip = #{operateIp,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.example.demo.trainExam.model.ExamCaExam">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jun 05 16:55:13 CST 2021.
    -->
    update exam_ca_exam
    set ca_id = #{caId,jdbcType=INTEGER},
      ca_code = #{caCode,jdbcType=VARCHAR},
      exam_id = #{examId,jdbcType=INTEGER},
      exam_score = #{examScore,jdbcType=REAL},
      exam_result = #{examResult,jdbcType=INTEGER},
      exam_date = #{examDate,jdbcType=TIMESTAMP},
      operator = #{operator,jdbcType=VARCHAR},
      operate_time = #{operateTime,jdbcType=TIMESTAMP},
      operate_ip = #{operateIp,jdbcType=VARCHAR}
    where id = #{id,jdbcType=INTEGER}
  </update>

  <delete id="deleteByCaIdAndExamId" parameterType="map">
    DELETE FROM exam_ca_exam
    WHERE ca_id = #{caId}
      AND exam_id = #{examId}
</delete>

  <select id="getByCaId" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from exam_ca_exam
    where ca_id = #{caId,jdbcType=INTEGER}
  </select>

  <select id="countList" resultType="int">
    SELECT count(1) FROM view_supervision_ca WHERE ca_score&gt;10
  </select>

  <select id="countListTrain" parameterType="map" resultType="int">
    SELECT count(1)
    FROM view_supervision_ca
    <if test="flag==0">
      WHERE company_id !=0 and (ca_score IS NULL or ca_score = 0)
    </if>
    <if test="flag==1">
      WHERE company_id !=0 and ca_score&gt;0
    </if>
  </select>

  <select id="countListExam" resultType="int">
    SELECT count(1) FROM exam_ca_exam WHERE exam_result = 1
  </select>

  <select id="getPage" resultMap="ExamEnquiryMap">
    SELECT a.*,b.id as subject_id,b.name as exam_name,b.qualified_score as qualified_score,b.total_score as total_score,b.exam_time as exam_time FROM
    (SELECT a.*,b.business_address,b.id_number as credit_number FROM
    (SELECT a.*,b.exam_id,b.exam_result,b.exam_date,b.exam_score
    FROM view_supervision_ca as a LEFT JOIN
    (SELECT ca_id,exam_id,MAX(exam_score) as exam_score,MAX(exam_date) as exam_date,MAX(exam_result) as exam_result FROM exam_ca_exam
    GROUP BY ca_id,exam_id)
    as b on a.user_id = b.ca_id WHERE a.ca_score&gt;10
    <if test="search.caName != null and search.caName != ''">AND a.name LIKE CONCAT('%',#{search.caName},'%')</if>
    <if test="search.idNumber != null and search.idNumber != ''">AND a.id_number LIKE CONCAT('%',#{search.idNumber},'%')</if>
    <if test="search.companyName != null and search.companyName != ''">AND a.company_name LIKE CONCAT('%',#{search.companyName},'%')</if>
    <if test="search.industry != null">AND a.industry = #{search.industry}</if>
    <if test="search.workType != null">AND a.work_type = #{search.workType}</if>
    <if test="search.examResult != null ">AND b.exam_result = #{search.examResult}</if> limit #{page.offset}, #{page.pageSize})
    as a LEFT JOIN supervision_enterprise as b on a.company_id = b.id) as a
    LEFT JOIN exam_subject as b on a.exam_id = b.id <if test="search.examName != null and search.examName != ''">WHERE b.name LIKE CONCAT('%',#{search.examName},'%')</if>
  </select>

  <select id="selectNewestCodeByDate" resultType="string">
    select ca_code
    from exam_ca_exam
    where exam_result = 1 and DATE_FORMAT(exam_date, "%Y") = DATE_FORMAT(#{date}, "%Y")
    order by id desc limit 1
  </select>

  <select id="getCaQualify" resultMap="ExamQualifyMap">
    select a.username,b.*
    from sys_user as a inner join exam_ca_exam as b
    on a.id = b.ca_id and a.id=#{caId,jdbcType=INTEGER}
    where b.ca_code != "" and b.exam_result = 1
  </select>
</mapper>